<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªä¹ å®¤ç›´æ’­ - ç®¡ç†åå°</title>
    <link rel="icon" href="/images/ADMINLOGO.png" type="image/png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-8" x-data="adminApp()">

    <div class="max-w-screen mx-auto space-y-8">
        <!-- Header -->
        <header class="flex justify-between items-center bg-white p-6 rounded-lg shadow-sm">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Study Room Admin</h1>
                <p class="text-gray-500">ç›´æ’­é—´åå°ç®¡ç†ç³»ç»Ÿ</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">Status</div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="font-mono text-green-600">ONLINE</span>
                </div>
            </div>
        </header>

        <!-- Current Session Control -->
        <section class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-semibold text-gray-700">å½“å‰ç›´æ’­çŠ¶æ€</h2>
                <button x-show="activeSessions.length > 0" @click="skipAllUsers()"
                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                    </svg>
                    å…¨éƒ¨å¼ºåˆ¶ç»“æŸ
                </button>
            </div>

            <template x-if="activeSessions.length === 0">
                <div
                    class="text-center py-8 text-gray-400 bg-gray-50 rounded-lg border-dashed border-2 border-gray-200">
                    <p class="text-xl">ğŸ˜´ å½“å‰æ²¡æœ‰æ­£åœ¨å­¦ä¹ çš„ç”¨æˆ·</p>
                    <p class="text-sm mt-2">ç­‰å¾…è§‚ä¼—å‘é€ "æ‰“å¡ é¡¹ç›®" ...</p>
                </div>
            </template>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="session in activeSessions" :key="session.uid">
                    <div
                        class="bg-blue-50 p-4 rounded-lg flex flex-col gap-3 relative overflow-hidden group hover:shadow-md transition">
                        <!-- BG Icon -->
                        <div class="absolute -right-4 -bottom-4 text-9xl text-blue-100 opacity-50 select-none z-0">
                            â³
                        </div>

                        <div class="relative z-10 flex justify-between items-start">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center text-xl font-bold text-blue-600">
                                    <span x-text="session.username.substring(0,1)"></span>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg" x-text="session.username"></h3>
                                    <p class="text-xs text-gray-500" x-text="'UID: ' + session.uid"></p>
                                </div>
                            </div>
                            <div class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-bold">
                                æ­£åœ¨å­¦ä¹ 
                            </div>
                        </div>

                        <div class="relative z-10 space-y-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">é¡¹ç›®:</span>
                                <span class="font-medium" x-text="session.project"></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500">è¿›åº¦:</span>
                                <span>
                                    <span class="font-mono font-bold text-blue-600"
                                        x-text="formatTime(session.duration)"></span>
                                    <span class="text-gray-400">/</span>
                                    <span class="text-sm text-gray-400"
                                        x-text="Math.floor(session.targetDuration/60) + 'm'"></span>
                                </span>
                            </div>
                            <!-- Progres Bar -->
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000"
                                    :style="`width: ${Math.min((session.duration / session.targetDuration) * 100, 100)}%`">
                                </div>
                            </div>
                        </div>

                        <div class="relative z-10 pt-2 border-t border-blue-100 flex justify-end">
                            <button @click="skipUser(session.uid)"
                                class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-sm font-medium transition flex items-center gap-2 group-hover:bg-red-500 group-hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                å¼ºåˆ¶ç»“æŸ / è·³è¿‡ (Skip)
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </section>

        <!-- Records Management -->
        <section class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-gray-500">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-semibold text-gray-700">æœ€è¿‘æ‰“å¡è®°å½• (Top 50)</h2>
                <button @click="loadRecords" class="text-sm text-blue-500 hover:underline">åˆ·æ–°åˆ—è¡¨ â†»</button>
            </div>

            <div class="overflow-x-auto max-h-64 overflow-y-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3">ID</th>
                            <th scope="col" class="px-6 py-3">UID</th>
                            <th scope="col" class="px-6 py-3">ç”¨æˆ·</th>
                            <th scope="col" class="px-6 py-3">é¡¹ç›®</th>
                            <th scope="col" class="px-6 py-3 text-right">å­¦ä¹ æ—¶é•¿</th>
                            <th scope="col" class="px-6 py-3 text-right">æ—¶é—´</th>
                            <th scope="col" class="px-6 py-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="records.length === 0">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-400">æš‚æ— å†å²è®°å½•</td>
                            </tr>
                        </template>

                        <template x-for="record in records" :key="record.id">
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4 font-mono text-gray-400" x-text="record.id"></td>
                                <td class="px-6 py-4 text-gray-500 font-mono text-xs" x-text="record.uid"></td>
                                <td class="px-6 py-4 font-medium text-gray-900" x-text="record.user"></td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs"
                                        x-text="record.project"></span>
                                </td>
                                <td class="px-6 py-4 text-right font-mono"
                                    x-text="Math.floor(record.duration / 60) + ' min'"></td>
                                <td class="px-6 py-4 text-right text-gray-400" x-text="formatDate(record.start_time)">
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <button @click="deleteRecord(record.id)"
                                        class="text-red-500 hover:text-red-700 font-medium hover:underline">
                                        åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- New: Data Insights & AI Summary -->
        <section class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500"
            x-data="{ queryUid: '', stats: null, aiLoading: false, aiText: '' }">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
                <span>ğŸ“Š æ•°æ®æ´å¯Ÿ & AI æ€»ç»“</span>
                <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">New</span>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left: Query Form -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŸ¥è¯¢ç”¨æˆ· (UID æˆ– æ˜µç§°)</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="queryUid" placeholder="è¾“å…¥ UID æˆ– ç”¨æˆ·å..."
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 border p-2">
                            <button @click="fetchUserStats(queryUid)"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition">
                                æŸ¥è¯¢
                            </button>
                        </div>
                    </div>

                    <template x-if="stats">
                        <div class="bg-purple-50 p-4 rounded-lg space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500">ç´¯è®¡å‚ä¸:</span>
                                <span class="font-bold text-gray-800" x-text="stats.total_sessions + ' æ¬¡'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">æ€»å­¦ä¹ æ—¶é•¿:</span>
                                <span class="font-bold text-gray-800"
                                    x-text="Math.floor(stats.total_duration_seconds / 60) + ' åˆ†é’Ÿ'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">æœ€çˆ±ç§‘ç›®:</span>
                                <span class="font-bold text-gray-800" x-text="stats.top_project || '-'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">æ´»è·ƒå¤©æ•°:</span>
                                <span class="font-bold text-gray-800" x-text="stats.active_days + ' å¤©'"></span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Right: AI Report -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-700">AI æ™ºèƒ½åˆ†ææŠ¥å‘Š</h3>
                        <button x-show="stats && !aiLoading" @click="generateAI(stats)"
                            class="text-xs text-purple-600 hover:text-purple-800 underline">
                            âœ¨ ç”Ÿæˆä¸ªæ€§åŒ–æ€»ç»“
                        </button>
                    </div>

                    <div
                        class="bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-sm h-48 overflow-y-auto relative">
                        <!-- Loading State -->
                        <div x-show="aiLoading"
                            class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-80">
                            <div class="animate-pulse flex flex-col items-center">
                                <span>AI COMPUTING...</span>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div x-show="!aiText && !aiLoading"
                            class="h-full flex items-center justify-center text-gray-500">
                            Waiting for data input...
                        </div>

                        <!-- Content -->
                        <div x-show="aiText" class="whitespace-pre-wrap">
                            <span class="text-purple-400">>> ANALYZING USER DATA...</span><br>
                            <span x-text="aiText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Configuration Panel -->
        <section class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500" x-data="configApp()">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
                <span>âš™ï¸ ç³»ç»Ÿé…ç½® (System Config)</span>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Display Durations -->
                <div class="space-y-4">
                    <h3 class="font-medium text-gray-800">æ˜¾ç¤ºæ—¶é•¿ (ç§’)</h3>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Widget æ˜¾ç¤ºæ—¶é•¿ (ç§’)</label>
                        <input type="number" x-model="config.displayDuration.widget"
                            class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">ä¸»é¡µè½®æ’­é—´éš” (ç§’)</label>
                        <input type="number" x-model="config.displayDuration.index"
                            class="w-full border rounded p-2 text-sm">
                    </div>
                </div>

                <!-- AI Prompts -->
                <div class="space-y-4">
                    <h3 class="font-medium text-gray-800">AI æç¤ºè¯ (Prompts)</h3>
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Widget çŒ«å¨˜è¯„ä»·æç¤ºè¯</label>
                        <textarea x-model="config.aiPrompts.widget" rows="4"
                            class="w-full border rounded p-2 text-xs font-mono"></textarea>
                        <p class="text-xs text-gray-400 mt-1">å¯ç”¨å˜é‡: {{username}}, {{duration}}</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-4">
                <button @click="resetDefaults"
                    class="px-6 py-2 bg-gray-500 text-white font-bold rounded hover:bg-gray-600 transition">
                    æ¢å¤é»˜è®¤ (Reset)
                </button>

                <button @click="saveConfig"
                    class="px-6 py-2 bg-yellow-500 text-white font-bold rounded hover:bg-yellow-600 transition flex items-center gap-2">
                    <span x-show="!saving">ä¿å­˜é…ç½® (Save)</span>
                    <span x-show="saving" class="animate-pulse">Saving...</span>
                </button>
            </div>
        </section>
    </div>
    </section>



    </div>

    <!-- Notification Toast -->
    <div class="fixed bottom-4 right-4 z-50 transform transition-all duration-300" x-show="toast.show"
        x-transition.opacity.scale.90>
        <div class="bg-gray-800 text-white px-6 py-3 rounded shadow-lg flex items-center gap-3">
            <span x-text="toast.message"></span>
        </div>
    </div>

    <script>
        function adminApp() {
            return {
                activeSessions: [],
                records: [],
                toast: { show: false, message: '' },
                pollTimer: null,

                init() {
                    this.loadState();
                    this.loadRecords();

                    // Poll State every 2s
                    this.pollTimer = setInterval(() => {
                        this.loadState();
                    }, 2000);
                },

                formatTime(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return `${m}:${s.toString().padStart(2, '0')}`;
                },

                formatDate(timestamp) {
                    if (!timestamp) return '-';
                    return new Date(timestamp).toLocaleString();
                },

                showToast(msg) {
                    this.toast.message = msg;
                    this.toast.show = true;
                    setTimeout(() => this.toast.show = false, 3000);
                },

                async loadState() {
                    try {
                        const res = await fetch('/api/state');
                        const data = await res.json();
                        this.activeSessions = data.sessions || [];
                    } catch (e) {
                        console.error("State Fetch Error", e);
                    }
                },

                async loadRecords() {
                    try {
                        const res = await fetch('/api/records?limit=50');
                        this.records = await res.json();
                    } catch (e) {
                        console.error("Records Fetch Error", e);
                    }
                },

                async skipUser(uid) {
                    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶ç»“æŸè¯¥ç”¨æˆ·çš„å­¦ä¹ å—ï¼Ÿ')) return;

                    try {
                        const res = await fetch('/api/control/skip', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uid })
                        });

                        if (res.ok) {
                            this.showToast('âœ… å·²è·³è¿‡ç”¨æˆ·');
                            this.loadState();
                            this.loadRecords(); // Refresh records to show new entry
                        } else {
                            this.showToast('âŒ æ“ä½œå¤±è´¥');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                async skipAllUsers() {
                    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶ç»“æŸæ‰€æœ‰ç”¨æˆ·çš„å­¦ä¹ å—ï¼Ÿæ‰€æœ‰æ—¶é•¿å°†è¢«è®°å½•ã€‚')) return;

                    try {
                        const res = await fetch('/api/control/skip-all', { method: 'POST' });
                        if (res.ok) {
                            const data = await res.json();
                            this.showToast(`âœ… å·²ç»“æŸ ${data.count} ä½ç”¨æˆ·çš„å­¦ä¹ `);
                            this.loadState();
                            this.loadRecords(); // Refresh records
                        } else {
                            this.showToast('âŒ æ“ä½œå¤±è´¥');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                async deleteRecord(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚')) return;

                    try {
                        const res = await fetch(`/api/records/${id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            this.showToast('âœ… åˆ é™¤æˆåŠŸ');
                            this.loadRecords();
                        } else {
                            this.showToast('âŒ åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                // --- New Stats Logic ---
                async fetchUserStats(uid) {
                    if (!uid) return;
                    // Reset
                    this.stats = null;
                    this.aiText = "";

                    try {
                        const res = await fetch(`/api/stats/user/${uid}`);
                        if (res.ok) {
                            this.stats = await res.json();
                            // Auto generate not triggered to save tokens
                        } else {
                            this.showToast('âŒ æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æ•°æ®');
                        }
                    } catch (e) {
                        console.error(e);
                    }
                },

                async generateAI(stats) {
                    this.aiLoading = true;
                    this.aiText = "";

                    try {
                        const res = await fetch('/api/ai/summary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ stats, context: 'user' })
                        });
                        const data = await res.json();

                        // Typewriter effect
                        const fullText = data.text;
                        this.aiLoading = false;

                        let i = 0;
                        const typeTimer = setInterval(() => {
                            this.aiText += fullText.charAt(i);
                            i++;
                            if (i >= fullText.length) clearInterval(typeTimer);
                        }, 50);

                    } catch (e) {
                        this.aiLoading = false;
                        this.aiText = "Error: AI Service Unavailable.";
                    }
                }
            }
        }

        function configApp() {
            return {
                config: {
                    displayDuration: { widget: 30000, index: 15000 },
                    aiPrompts: { widget: '' }
                },
                defaults: {
                    displayDuration: { widget: 15, index: 10 },
                    aiPrompts: { widget: "ç”¨æˆ·ï¼š{{username}}\næ—¶é•¿ï¼š{{duration}}åˆ†é’Ÿ\nä»»åŠ¡ï¼šä»¥è‡ªä¹ å®¤çŒ«å¨˜è€æ¿èº«ä»½ï¼Œç”¨ä¸€å¥è¯ï¼ˆ20å­—ä»¥å†…ï¼‰è¯„ä»·è¯¥ç”¨æˆ·.æ ¼å¼:(æ‚¨å·²ä¸“æ³¨xæ—¶xåˆ†,â€¦â€¦)ã€‚é£æ ¼ï¼šåŸºäºæ•°æ®,å¹½é»˜æ¶æ„æˆ–æ¸©æŸ”å¤¸å¥–,æ¯å¥è¯åé¢éƒ½å¸¦å–µã€‚" }
                },
                saving: false,

                init() {
                    this.loadConfig();
                },

                async loadConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const data = await res.json();
                        // Deep mergeish & Convert ms to s for display
                        if (data.displayDuration) {
                            this.config.displayDuration.widget = data.displayDuration.widget / 1000;
                            this.config.displayDuration.index = data.displayDuration.index / 1000;
                        }
                        if (data.ai && data.ai.prompts) this.config.aiPrompts = data.ai.prompts;
                    } catch (e) {
                        console.error("Config Load Error", e);
                    }
                },

                async saveConfig() {
                    this.saving = true;
                    try {
                        // Convert s back to ms for saving
                        const payload = {
                            displayDuration: {
                                widget: this.config.displayDuration.widget * 1000,
                                index: this.config.displayDuration.index * 1000
                            },
                            aiPrompts: this.config.aiPrompts
                        };

                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        alert(data.message);
                    } catch (e) {
                        alert('Save Failed');
                    } finally {
                        this.saving = false;
                    }
                },

                resetDefaults() {
                    if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤é…ç½®å—ï¼Ÿ(éœ€è¦ç‚¹å‡»ä¿å­˜æ‰ç”Ÿæ•ˆ)')) return;
                    // Deep copy
                    this.config.displayDuration.widget = this.defaults.displayDuration.widget;
                    this.config.displayDuration.index = this.defaults.displayDuration.index;
                    this.config.aiPrompts.widget = this.defaults.aiPrompts.widget;
                }
            }
        }
    </script>
</body>

</html>