<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªä¹ å®¤ç›´æ’­ - ç®¡ç†åå°</title>
    <link rel="icon" href="/images/ADMINLOGO.png" type="image/png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-4" x-data="adminApp()" x-cloak>
    <div class="max-w-6xl mx-auto space-y-6">

        <!-- Header -->
        <header class="bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                    S
                </div>
                <h1 class="text-xl font-bold text-gray-800">Study Room Live <span class="text-xs font-normal text-gray-500 ml-2">v1.2</span></h1>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <a href="/" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1">
                    <span>ğŸ“º</span> è®¡æ—¶å™¨é¡µ
                </a>
                <a href="/stats.html" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1">
                    <span>ğŸ“Š</span> æ’è¡Œæ¦œ
                </a>
                <a href="/ai_widget.html" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1">
                    <span>ğŸ¤–</span> AIæŒ‚ä»¶
                </a>
                <div class="flex items-center gap-2 bg-green-50 text-green-700 px-3 py-1 rounded-full border border-green-200">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    System Online
                </div>
            </div>
        </header>

        <!-- Current Session Control -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Active Users List -->
            <div class="md:col-span-2 bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 flex justify-between items-center">
                    <span>ğŸ‘¥ å½“å‰ä¸“æ³¨ä¸­ (Active Sessions)</span>
                    <span class="text-sm bg-purple-100 text-purple-700 px-2 py-1 rounded-full" x-text="activeSessions.length + ' äºº'"></span>
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <template x-for="user in activeSessions" :key="user.uid">
                        <div class="border rounded-lg p-4 flex flex-col gap-2 relative bg-gray-50 hover:bg-white transition-all hover:shadow-md">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xs">
                                        <span x-text="user.username.substring(0,1)"></span>
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-800" x-text="user.username"></div>
                                        <div class="text-xs text-gray-500 font-mono">UID: <span x-text="user.uid"></span></div>
                                    </div>
                                </div>
                                <button @click="skipUser(user.uid)" class="text-red-500 hover:bg-red-50 p-1 rounded transition" title="å¼ºåˆ¶ç»“æŸ">
                                    ğŸ›‘
                                </button>
                            </div>
                            
                            <div class="mt-2 text-sm bg-white p-2 rounded border border-gray-100">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">é¡¹ç›®:</span>
                                    <span class="font-medium text-gray-800" x-text="user.project || 'è‡ªä¹ '"></span>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span class="text-gray-500">è¿›åº¦:</span>
                                    <span class="font-mono text-blue-600">
                                        <span x-text="formatTime(user.duration)"></span> / 
                                        <span x-text="formatTime(user.targetDuration)"></span>
                                    </span>
                                </div>
                                <!-- Progress Bar -->
                                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2 overflow-hidden">
                                    <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-1000"
                                         :style="'width: ' + Math.min(100, (user.duration / user.targetDuration) * 100) + '%'"></div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="activeSessions.length === 0" class="col-span-2 py-8 text-center text-gray-400 border-2 border-dashed rounded-lg">
                        ğŸ˜´ å½“å‰æ²¡æœ‰äººåœ¨è‡ªä¹ 
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t flex justify-end" x-show="activeSessions.length > 0">
                    <button @click="skipAllUsers" class="text-red-600 hover:text-red-800 text-sm font-medium hover:underline">
                        âš ï¸ å…¨éƒ¨å¼ºåˆ¶ç»“æŸ (Emergency Stop All)
                    </button>
                </div>
            </div>

            <!-- Quick Actions / AI Tool -->
            <div class="space-y-6">
                <!-- Data Check -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">ğŸ” æ•°æ®æŸ¥è¯¢</h2>
                    <div class="flex gap-2">
                        <input type="text" placeholder="è¾“å…¥ UID..." id="queryUid" 
                            class="flex-1 border rounded p-2 text-sm font-mono">
                        <button @click="fetchUserStats(document.getElementById('queryUid').value)" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                            æŸ¥è¯¢
                        </button>
                    </div>

                    <!-- AI Summary Result -->
                    <div x-show="stats" class="mt-4 p-4 bg-gray-50 rounded border border-gray-100 text-sm">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-gray-700" x-text="stats?.user?.username"></span>
                            <span class="text-xs text-gray-500">Total: <span x-text="formatTime(stats?.totalDuration || 0)"></span></span>
                        </div>
                        <button @click="generateAI(stats)" :disabled="aiLoading"
                            class="w-full py-1.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition text-xs font-bold flex justify-center items-center gap-2">
                            <span x-show="!aiLoading">âœ¨ ç”Ÿæˆ AI è¯„ä»· (Preview)</span>
                            <span x-show="aiLoading" class="animate-spin">â³</span>
                        </button>
                        
                        <!-- Content -->
                        <div x-show="aiText" class="whitespace-pre-wrap mt-3 text-gray-700 font-mono text-xs leading-relaxed bg-white p-2 rounded border">
                            <span class="text-purple-400 font-bold">>> ANALYZING USER DATA...</span><br>
                            <span x-text="aiText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Configuration Panel -->
        <section class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500" x-data="configApp()">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
                <span>âš™ï¸ ç³»ç»Ÿé…ç½® (System Config)</span>
            </h2>

            <!-- 1. AI Connection (Cherry Studio Style) -->
            <!-- Using Parent Scope directly, logic moved to configApp() -->
            <div class="mb-8 border-b pb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-medium text-gray-800 flex items-center gap-2">
                        <span>ğŸ”Œ AI æœåŠ¡å•†é…ç½®</span>
                        <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded">ä¿®æ”¹åªå½±å“æ–°è¯·æ±‚</span>
                    </h3>
                    <button @click="testConnection()" :disabled="!config.ai.apiKey || testing"
                        class="px-3 py-1 text-sm rounded border flex items-center gap-1 transition"
                        :class="testSuccess === true ? 'bg-green-50 text-green-600 border-green-200' : (testSuccess === false ? 'bg-red-50 text-red-600 border-red-200' : 'bg-white text-gray-600 hover:bg-gray-50')">
                        <span x-show="testing" class="animate-spin">ğŸ”„</span>
                        <span x-show="!testing && testSuccess === true">âœ…</span>
                        <span x-show="!testing && testSuccess === false">âŒ</span>
                        <span x-show="!testing && testSuccess === null">âš¡</span>
                        <span x-text="testing ? 'æµ‹è¯•ä¸­...' : (testSuccess === true ? 'æµ‹è¯•é€šè¿‡' : 'æµ‹è¯•è¿é€šæ€§')"></span>
                    </button>   
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Provider Select -->
                    <div class="col-span-1 md:col-span-2">
                         <label class="block text-sm text-gray-500 mb-2">æœåŠ¡å•† (Switch Provider)</label>
                         <div class="flex flex-wrap gap-3">
                            <template x-for="p in providers" :key="p.value">
                                <button @click="switchProvider(p.value)"
                                    class="px-4 py-2 rounded-lg border flex items-center gap-2 transition hover:shadow-sm"
                                    :class="currentProvider === p.value ? 'border-purple-500 bg-purple-50 text-purple-700 ring-1 ring-purple-500' : 'border-gray-200 hover:border-gray-300 bg-white'">
                                    <span x-text="p.icon" class="text-lg"></span>
                                    <span class="text-sm font-medium" x-text="p.label"></span>
                                </button>
                            </template>
                         </div>
                    </div>

                    <!-- Base URL -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm text-gray-500 mb-1">Base URL</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400">ğŸŒ</span>
                            <input type="text" x-model="config.ai.baseUrl" 
                                class="w-full border rounded pl-9 p-2 text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="https://..." :readonly="currentProvider !== 'custom'">
                        </div>
                    </div>

                    <!-- API Key -->
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">API Key</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”‘</span>
                            <div class="w-full border rounded pl-9 p-2 text-sm font-mono bg-white flex items-center">
                                <input type="password" :value="config.ai.apiKey" @input="updateKey($event.target.value)" placeholder="sk-..."
                                class="flex-1 outline-none font-mono">
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" x-text="'Key stored locally for: ' + (providers.find(p=>p.value===currentProvider)?.label || currentProvider)"></p>
                    </div>

                    <!-- Model Select -->
                    <div>
                        <label class="block text-sm text-gray-500 mb-1">Model Name</label>
                        <div class="relative">
                             <span class="absolute left-3 top-2.5 text-gray-400">ğŸ§ </span>
                             
                             <!-- If models fetched, show select, else show input -->
                             <template x-if="modelsList.length > 0">
                                <select :value="config.ai.model" @change="updateModel($event.target.value)"
                                    class="w-full border rounded pl-9 p-2 text-sm font-mono appearance-none bg-white">
                                    <template x-for="m in modelsList" :key="m">
                                        <option :value="m" x-text="m" :selected="config.ai.model === m"></option>
                                    </template>
                                </select>
                             </template>

                             <template x-if="modelsList.length === 0">
                                <input type="text" :value="config.ai.model" @input="updateModel($event.target.value)" placeholder="gpt-3.5-turbo"
                                    class="w-full border rounded pl-9 p-2 text-sm font-mono">
                             </template>
                             
                             <div class="absolute right-3 top-2.5 text-xs text-gray-400 pointer-events-none">
                                 <span x-show="modelsList.length > 0">â–¼</span>
                             </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" x-show="modelsList.length === 0">ç‚¹å‡»å³ä¸Šè§’"æµ‹è¯•è¿é€šæ€§"å¯è‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 2. Durations -->
                <div class="space-y-4">
                    <h3 class="font-medium text-gray-800">â±ï¸ æ—¶é•¿é…ç½®</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">Widget æ˜¾ç¤º(ç§’)</label>
                            <input type="number" x-model="config.displayDuration.widget"
                                class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 mb-1">ä¸»é¡µè½®æ’­(ç§’)</label>
                            <input type="number" x-model="config.displayDuration.index"
                                class="w-full border rounded p-2 text-sm">
                        </div>
                        <div class="col-span-2">
                             <label class="block text-sm text-gray-500 mb-1">ä»¥ä¿®ä»£ä¼‘(ä¼‘æ¯é—´éš”)</label>
                             <div class="flex items-center gap-2">
                                <input type="number" x-model="config.multiSession.breakDuration"
                                    class="w-full border rounded p-2 text-sm">
                                <span class="text-sm text-gray-400">ç§’</span>
                             </div>
                             <p class="text-xs text-gray-400 mt-1">ä¾‹å¦‚: æ‰“å¡3æ¬¡, æ¯æ¬¡é—´éš”ä¼‘æ¯å¤šä¹…</p>
                        </div>
                    </div>
                </div>

                <!-- 3. Prompts -->
                <div class="space-y-4">
                    <h3 class="font-medium text-gray-800">ğŸ§  AI è§’è‰²è®¾å®š (Prompts)</h3>
                    
                    <!-- Admin Prompt -->
                    <div>
                         <label class="block text-sm text-gray-600 font-bold mb-1">ğŸ± Widget çŒ«å¨˜è¯„ä»·</label>
                         <textarea x-model="config.ai.prompts.widget" rows="3"
                             class="w-full border rounded p-2 text-xs font-mono bg-gray-50 text-gray-700">
                            </textarea>
                             
                        <p class="text-xs text-gray-400 mt-1">æ§åˆ¶ AI å¦‚ä½•å®ç°Widgetä¸­çš„è¯„ä»·ã€‚å˜é‡: {{duration}}{{username}}</p>
                   </div>
                    </div>

                    <!-- Normalize Prompt -->
                    <div>
                        <label class="block text-sm text-gray-600 font-bold mb-1">ğŸ›¡ï¸ é¡¹ç›®åå®¡æ ¸ä¸è§„èŒƒåŒ– (Normalize)</label>
                        <textarea x-model="config.ai.prompts.normalize" rows="6"
                            class="w-full border rounded p-2 text-xs font-mono bg-gray-50 text-gray-700"
                            placeholder="..."></textarea>
                        <p class="text-xs text-gray-400 mt-1">æ§åˆ¶ AI å¦‚ä½•åˆå¹¶åŒä¹‰è¯åŠæ‹¦æˆªè¿ç¦è¯ã€‚å˜é‡: {{existingProjects}}</p>
                   </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t flex justify-end gap-4">
                <button @click="resetDefaults"
                    class="px-6 py-2 bg-gray-100 text-gray-600 font-bold rounded hover:bg-gray-200 transition">
                    æ¢å¤é»˜è®¤
                </button>

                <button @click="saveConfig"
                    class="px-6 py-2 bg-yellow-500 text-white font-bold rounded hover:bg-yellow-600 transition flex items-center gap-2 shadow-sm">
                    <span x-show="!saving">ğŸ’¾ ä¿å­˜å…¨éƒ¨é…ç½®</span>
                    <span x-show="saving" class="animate-pulse">ä¿å­˜ä¸­...</span>
                </button>
            </div>
        </section>
    </div>

    <!-- Notification Toast -->
    <div class="fixed bottom-4 right-4 z-50 transform transition-all duration-300" x-show="toast.show"
        x-transition.opacity.scale.90>
        <div class="bg-gray-800 text-white px-6 py-3 rounded shadow-lg flex items-center gap-3">
            <span x-text="toast.message"></span>
        </div>
    </div>

    <script>
        function adminApp() {
            return {
                activeSessions: [],
                records: [],
                toast: { show: false, message: '' },
                pollTimer: null,
                
                // --- AI Logic Merged into Main App ---
                providers: [
                    { label: 'OpenAI', value: 'openai', url: 'https://api.openai.com/v1', icon: 'ğŸ¤–' },
                    { label: 'DeepSeek (æ·±åº¦æ±‚ç´¢)', value: 'deepseek', url: 'https://api.deepseek.com', icon: 'ğŸ‹' },
                    { label: 'SiliconFlow (ç¡…åŸºæµåŠ¨)', value: 'siliconflow', url: 'https://api.siliconflow.cn/v1', icon: 'ğŸŒŠ' },
                    { label: 'Moonshot (Kimi)', value: 'moonshot', url: 'https://api.moonshot.cn/v1', icon: 'ğŸŒ™' },
                    { label: 'Aliyun (é€šä¹‰åƒé—®)', value: 'aliyun', url: 'https://dashscope.aliyuncs.com/compatible-mode/v1', icon: 'â˜ï¸' },
                    { label: 'ZhipuAI (æ™ºè°±GLM)', value: 'zhipu', url: 'https://open.bigmodel.cn/api/paas/v4', icon: 'ğŸ§ ' },
                    { label: 'Google Gemini', value: 'gemini', url: 'https://generativelanguage.googleapis.com/v1beta/openai', icon: 'âœ¨' },
                    { label: 'Custom (è‡ªå®šä¹‰)', value: 'custom', url: '', icon: 'ğŸ”§' }
                ],
                currentProvider: 'custom',
                providerKeys: {},
                providerModels: {},
                providerSelections: {},
                modelsList: [],
                testing: false,
                testSuccess: null,
                // -------------------------------------

                init() {
                    this.loadState();
                    this.loadRecords();

                    // Poll State every 2s
                    this.pollTimer = setInterval(() => {
                        this.loadState();
                    }, 2000);
                },

                formatTime(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return `${m}:${s.toString().padStart(2, '0')}`;
                },

                formatDate(timestamp) {
                    if (!timestamp) return '-';
                    return new Date(timestamp).toLocaleString();
                },

                showToast(msg) {
                    this.toast.message = msg;
                    this.toast.show = true;
                    setTimeout(() => this.toast.show = false, 3000);
                },

                async loadState() {
                    try {
                        const res = await fetch('/api/state');
                        const data = await res.json();
                        this.activeSessions = data.sessions || [];
                    } catch (e) {
                        console.error("State Fetch Error", e);
                    }
                },

                async loadRecords() {
                    try {
                        const res = await fetch('/api/records?limit=50');
                        this.records = await res.json();
                    } catch (e) {
                        console.error("Records Fetch Error", e);
                    }
                },

                async skipUser(uid) {
                    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶ç»“æŸè¯¥ç”¨æˆ·çš„å­¦ä¹ å—ï¼Ÿ')) return;

                    try {
                        const res = await fetch('/api/control/skip', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uid })
                        });

                        if (res.ok) {
                            this.showToast('âœ… å·²è·³è¿‡ç”¨æˆ·');
                            this.loadState();
                            this.loadRecords(); // Refresh records to show new entry
                        } else {
                            this.showToast('âŒ æ“ä½œå¤±è´¥');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                async skipAllUsers() {
                    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶ç»“æŸæ‰€æœ‰ç”¨æˆ·çš„å­¦ä¹ å—ï¼Ÿæ‰€æœ‰æ—¶é•¿å°†è¢«è®°å½•ã€‚')) return;

                    try {
                        const res = await fetch('/api/control/skip-all', { method: 'POST' });
                        if (res.ok) {
                            const data = await res.json();
                            this.showToast(`âœ… å·²ç»“æŸ ${data.count} ä½ç”¨æˆ·çš„å­¦ä¹ `);
                            this.loadState();
                            this.loadRecords(); // Refresh records
                        } else {
                            this.showToast('âŒ æ“ä½œå¤±è´¥');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                async deleteRecord(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚')) return;

                    try {
                        const res = await fetch(`/api/records/${id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            this.showToast('âœ… åˆ é™¤æˆåŠŸ');
                            this.loadRecords();
                        } else {
                            this.showToast('âŒ åˆ é™¤å¤±è´¥');
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                },

                // --- New Stats Logic ---
                async fetchUserStats(uid) {
                    if (!uid) return;
                    this.stats = null;
                    this.aiText = "";

                    try {
                        const res = await fetch(`/api/stats/user/${uid}`);
                        if (res.ok) {
                            this.stats = await res.json();
                        } else {
                            this.showToast('âŒ æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æ•°æ®');
                        }
                    } catch (e) {
                        console.error(e);
                    }
                },

                async generateAI(stats) {
                    this.aiLoading = true;
                    this.aiText = "";

                    try {
                        const res = await fetch('/api/ai/summary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ stats, context: 'user' })
                        });
                        const data = await res.json();
                        const fullText = data.text;
                        this.aiLoading = false;

                        let i = 0;
                        const typeTimer = setInterval(() => {
                            this.aiText += fullText.charAt(i);
                            i++;
                            if (i >= fullText.length) clearInterval(typeTimer);
                        }, 50);

                    } catch (e) {
                        this.aiLoading = false;
                        this.aiText = "Error: AI Service Unavailable.";
                    }
                }
            }
        }

        function configApp() {
            return {
                config: {
                    displayDuration: { widget: 30000, index: 15000 },
                    ai: { 
                        apiKey: '', 
                        baseUrl: '', 
                        model: '', 
                        prompts: { widget: '', normalize: '' } 
                    },
                    multiSession: { breakDuration: 300 } 
                },
                defaults: {
                    displayDuration: { widget: 15, index: 10 },
                    aiPrompts: { widget: "..." }, // Simplified default
                    multiSession: { breakDuration: 300 } 
                },
                saving: false,
                
                // Inherit or Share? 
                // The structure implies configApp is separate X-Data. 
                // We need to duplicate the AI Logic here or make it mixed in.
                // REFACTOR: The HTML structure has TWO x-data roots? 
                // Body: x-data="adminApp()"
                // Section: x-data="configApp()"
                // They are nested. Body wraps Section.
                // Alpine scopes are lexical. configApp children see configApp's data.
                // BUT configApp children do NOT see adminApp's data unless accessed via $dispatch or global.
                // WE MUST COPY AI LOGIC INTO CONFIGAPP as that's where the UI is.
                
                providers: [
                    { label: 'OpenAI', value: 'openai', url: 'https://api.openai.com/v1', icon: 'ğŸ¤–' },
                    { label: 'DeepSeek (æ·±åº¦æ±‚ç´¢)', value: 'deepseek', url: 'https://api.deepseek.com', icon: 'ğŸ‹' },
                    { label: 'SiliconFlow (ç¡…åŸºæµåŠ¨)', value: 'siliconflow', url: 'https://api.siliconflow.cn/v1', icon: 'ğŸŒŠ' },
                    { label: 'Moonshot (Kimi)', value: 'moonshot', url: 'https://api.moonshot.cn/v1', icon: 'ğŸŒ™' },
                    { label: 'Aliyun (é€šä¹‰åƒé—®)', value: 'aliyun', url: 'https://dashscope.aliyuncs.com/compatible-mode/v1', icon: 'â˜ï¸' },
                    { label: 'ZhipuAI (æ™ºè°±GLM)', value: 'zhipu', url: 'https://open.bigmodel.cn/api/paas/v4', icon: 'ğŸ§ ' },
                    { label: 'Google Gemini', value: 'gemini', url: 'https://generativelanguage.googleapis.com/v1beta/openai', icon: 'âœ¨' },
                    { label: 'Custom (è‡ªå®šä¹‰)', value: 'custom', url: '', icon: 'ğŸ”§' }
                ],
                currentProvider: 'custom',
                providerKeys: {},
                providerModels: {},
                providerSelections: {},
                modelsList: [],
                testing: false,
                testSuccess: null,

                init() {
                    this.loadConfig().then(() => {
                        this.initProvider();
                    });
                },

                initProvider() {
                    try {
                        const savedKeys = localStorage.getItem('study_room_provider_keys');
                        if (savedKeys) this.providerKeys = JSON.parse(savedKeys);
                        const savedModels = localStorage.getItem('study_room_provider_models');
                        if (savedModels) this.providerModels = JSON.parse(savedModels);
                        const savedSelections = localStorage.getItem('study_room_provider_selections');
                        if (savedSelections) this.providerSelections = JSON.parse(savedSelections);
                    } catch(e) {}

                    if (this.config.ai) {
                        const match = this.providers.find(p => p.url === this.config.ai.baseUrl);
                        if (match) {
                            this.currentProvider = match.value;
                            this.providerKeys[this.currentProvider] = this.config.ai.apiKey;
                            this.providerSelections[this.currentProvider] = this.config.ai.model;
                        } else {
                            this.currentProvider = 'custom';
                        }
                    }
                    this.modelsList = this.providerModels[this.currentProvider] || [];
                },

                switchProvider(newVal) {
                    const oldVal = this.currentProvider;
                    if (this.config.ai.model) this.providerSelections[oldVal] = this.config.ai.model;

                    this.currentProvider = newVal;
                    const p = this.providers.find(x => x.value === newVal);
                    
                    if (p && p.value !== 'custom') {
                        this.config.ai.baseUrl = p.url;
                    }

                    this.config.ai.apiKey = this.providerKeys[newVal] || '';
                    this.modelsList = this.providerModels[newVal] || [];
                    this.config.ai.model = this.providerSelections[newVal] || '';

                    this.testSuccess = null;
                    this.saveLocalData();
                },

                updateKey(val) {
                    this.config.ai.apiKey = val;
                    this.providerKeys[this.currentProvider] = val;
                    this.saveLocalData();
                },
                
                updateModel(val) {
                    this.config.ai.model = val;
                    this.providerSelections[this.currentProvider] = val;
                    this.saveLocalData(); 
                },

                saveLocalData() {
                    localStorage.setItem('study_room_provider_keys', JSON.stringify(this.providerKeys));
                    localStorage.setItem('study_room_provider_models', JSON.stringify(this.providerModels));
                    localStorage.setItem('study_room_provider_selections', JSON.stringify(this.providerSelections));
                },

                async testConnection() {
                    this.testing = true;
                    this.testSuccess = null;
                    try {
                        const res = await fetch('/api/ai/models', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                baseUrl: this.config.ai.baseUrl,
                                apiKey: this.config.ai.apiKey
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.testSuccess = true;
                            const freshModels = data.models || [];
                            if (freshModels.length > 0) {
                                this.modelsList = freshModels;
                                this.providerModels[this.currentProvider] = freshModels;
                                if (!this.config.ai.model) this.updateModel(freshModels[0]);
                                this.showToast('âœ… è¿æ¥æˆåŠŸï¼å·²è·å–æ¨¡å‹åˆ—è¡¨');
                            } else {
                                this.showToast('âš ï¸ è¿æ¥æˆåŠŸï¼Œä½†éœ€æ‰‹åŠ¨è¾“å…¥æ¨¡å‹');
                            }
                            this.saveLocalData();
                        } else {
                            this.testSuccess = false;
                            alert('è¿æ¥å¤±è´¥: ' + (data.error || 'Unknown Error'));
                        }
                    } catch(e) {
                        this.testSuccess = false;
                        alert('è¯·æ±‚é”™è¯¯: ' + e.message);
                    } finally {
                        this.testing = false;
                    }
                },

                async loadConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const data = await res.json();
                        
                        if (data.displayDuration) {
                            this.config.displayDuration.widget = data.displayDuration.widget / 1000;
                            this.config.displayDuration.index = data.displayDuration.index / 1000;
                        }
                        if (data.multiSession) {
                            this.config.multiSession.breakDuration = data.multiSession.breakDuration / 1000;
                        }

                        if (data.ai) {
                            this.config.ai.apiKey = data.ai.apiKey || '';
                            this.config.ai.baseUrl = data.ai.baseUrl || '';
                            this.config.ai.model = data.ai.model || '';
                            if (data.ai.prompts) {
                                this.config.ai.prompts.widget = data.ai.prompts.widget || '';
                                this.config.ai.prompts.normalize = data.ai.prompts.normalize || '';
                            }
                        }
                    } catch (e) {
                        console.error("Config Load Error", e);
                    }
                },

                async saveConfig() {
                    this.saving = true;
                    try {
                        const payload = {
                            displayDuration: {
                                widget: this.config.displayDuration.widget * 1000,
                                index: this.config.displayDuration.index * 1000
                            },
                            multiSession: {
                                breakDuration: this.config.multiSession.breakDuration * 1000
                            },
                            ai: {
                                apiKey: this.config.ai.apiKey,
                                baseUrl: this.config.ai.baseUrl,
                                model: this.config.ai.model,
                                prompts: {
                                    widget: this.config.ai.prompts.widget,
                                    normalize: this.config.ai.prompts.normalize
                                }
                            }
                        };

                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        alert(data.message); 
                    } catch (e) {
                        alert('Save Failed');
                    } finally {
                        this.saving = false;
                    }
                },

                resetDefaults() {
                    if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤é…ç½®å—ï¼Ÿ')) return;
                    this.config.displayDuration.widget = 30;
                    this.config.displayDuration.index = 15;
                    this.config.multiSession.breakDuration = 300;
                },
                
                showToast(msg) {
                     alert(msg); // Simple fallback for now since accessing parent scope is tricky in rewrite
                }
            }
        }
    </script>
</body>
</html>